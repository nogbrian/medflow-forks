# MEDFLOW FORKS - Coolify Docker Compose
services:
  integration:
    build:
      context: ./integration
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - "8000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.integration.rule=Host(`api.trafegoparaconsultorios.com.br`)"
      - "traefik.http.routers.integration.entrypoints=https"
      - "traefik.http.routers.integration.tls=true"
      - "traefik.http.routers.integration.tls.certresolver=letsencrypt"
      - "traefik.http.services.integration.loadbalancer.server.port=8000"
    environment:
      APP_ENV: ${APP_ENV:-production}
      DEBUG: ${DEBUG:-false}
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}
      REDIS_URL: ${REDIS_URL:?REDIS_URL is required}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET:?WEBHOOK_SECRET is required}
      LLM_PROVIDER: ${LLM_PROVIDER:-anthropic}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      REPLICATE_API_KEY: ${REPLICATE_API_KEY:-}
      TWENTY_API_URL: ${TWENTY_API_URL:-}
      TWENTY_API_KEY: ${TWENTY_API_KEY:-}
      CALCOM_API_URL: ${CALCOM_API_URL:-}
      CALCOM_API_KEY: ${CALCOM_API_KEY:-}
      CHATWOOT_API_URL: ${CHATWOOT_API_URL:-}
      CHATWOOT_API_KEY: ${CHATWOOT_API_KEY:-}
      EVOLUTION_API_URL: ${EVOLUTION_API_URL:-}
      EVOLUTION_API_KEY: ${EVOLUTION_API_KEY:-}
      CORS_ORIGINS_RAW: ${CORS_ORIGINS_RAW:-http://localhost:3000}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - agent_storage:/tmp/agno
    networks:
      - coolify
    deploy:
      resources:
        limits:
          memory: 1G

  web:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://integration:8000}
        - NEXT_PUBLIC_CREATIVE_STUDIO_URL=${NEXT_PUBLIC_CREATIVE_STUDIO_URL:-http://creative-studio:3001}
    restart: unless-stopped
    expose:
      - "3000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`medflow.trafegoparaconsultorios.com.br`)"
      - "traefik.http.routers.web.entrypoints=https"
      - "traefik.http.routers.web.tls=true"
      - "traefik.http.routers.web.tls.certresolver=letsencrypt"
      - "traefik.http.services.web.loadbalancer.server.port=3000"
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://integration:8000}
      NEXT_PUBLIC_CREATIVE_STUDIO_URL: ${NEXT_PUBLIC_CREATIVE_STUDIO_URL:-http://creative-studio:3001}
      API_URL: http://integration:8000
      NODE_ENV: production
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      integration:
        condition: service_healthy
    networks:
      - coolify
    deploy:
      resources:
        limits:
          memory: 512M

  creative-studio:
    build:
      context: ./creative-studio
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - "3001"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.creative-studio.rule=Host(`studio.trafegoparaconsultorios.com.br`)"
      - "traefik.http.routers.creative-studio.entrypoints=https"
      - "traefik.http.routers.creative-studio.tls=true"
      - "traefik.http.routers.creative-studio.tls.certresolver=letsencrypt"
      - "traefik.http.services.creative-studio.loadbalancer.server.port=3001"
    environment:
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - coolify
    deploy:
      resources:
        limits:
          memory: 256M

networks:
  coolify:
    external: true
    name: coolify

volumes:
  agent_storage:
    driver: local
