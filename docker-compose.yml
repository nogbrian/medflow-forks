# MEDFLOW FORKS - Coolify Docker Compose
services:
  integration:
    build:
      context: ./integration
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - "8000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.integration.rule=Host(`api.trafegoparaconsultorios.com.br`)"
      - "traefik.http.routers.integration.entrypoints=https"
      - "traefik.http.routers.integration.tls=true"
      - "traefik.http.routers.integration.tls.certresolver=letsencrypt"
      - "traefik.http.services.integration.loadbalancer.server.port=8000"
    environment:
      # Application
      APP_ENV: ${APP_ENV:-production}
      DEBUG: ${DEBUG:-false}
      # Infrastructure
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}
      REDIS_URL: ${REDIS_URL:?REDIS_URL is required}
      # Security
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET:?WEBHOOK_SECRET is required}
      # LLM / Agno
      LLM_PROVIDER: ${LLM_PROVIDER:-anthropic}
      MODEL_SMART: ${MODEL_SMART:-claude-sonnet-4-5-20250514}
      MODEL_FAST: ${MODEL_FAST:-claude-haiku-4-20250514}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      # Twenty CRM
      TWENTY_API_URL: ${TWENTY_API_URL:-https://crm.trafegoparaconsultorios.com.br}
      TWENTY_API_KEY: ${TWENTY_API_KEY:-}
      # Cal.com
      CALCOM_API_URL: ${CALCOM_API_URL:-https://agenda.trafegoparaconsultorios.com.br}
      CALCOM_API_KEY: ${CALCOM_API_KEY:-}
      CALCOM_EVENT_TYPE_ID_DEFAULT: ${CALCOM_EVENT_TYPE_ID_DEFAULT:-1}
      # Chatwoot
      CHATWOOT_API_URL: ${CHATWOOT_API_URL:-https://inbox.trafegoparaconsultorios.com.br}
      CHATWOOT_API_KEY: ${CHATWOOT_API_KEY:-}
      CHATWOOT_PLATFORM_TOKEN: ${CHATWOOT_PLATFORM_TOKEN:-}
      CHATWOOT_ACCOUNT_ID: ${CHATWOOT_ACCOUNT_ID:-1}
      CHATWOOT_INBOX_ID: ${CHATWOOT_INBOX_ID:-1}
      CHATWOOT_HUMAN_TEAM_ID: ${CHATWOOT_HUMAN_TEAM_ID:-1}
      # WhatsApp (Evolution API)
      EVOLUTION_API_URL: ${EVOLUTION_API_URL:-}
      EVOLUTION_API_KEY: ${EVOLUTION_API_KEY:-}
      EVOLUTION_INSTANCE_AGENCIA: ${EVOLUTION_INSTANCE_AGENCIA:-agencia}
      # Image / Creative
      REPLICATE_API_KEY: ${REPLICATE_API_KEY:-}
      NANOBANANA_API_KEY: ${NANOBANANA_API_KEY:-}
      # Social / Ads
      META_ACCESS_TOKEN: ${META_ACCESS_TOKEN:-}
      # Scraping
      APIFY_TOKEN: ${APIFY_TOKEN:-}
      # CORS
      CORS_ORIGINS_RAW: ${CORS_ORIGINS_RAW:-https://medflow.trafegoparaconsultorios.com.br,https://studio.trafegoparaconsultorios.com.br,https://intel.trafegoparaconsultorios.com.br,https://app.agno.com}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - agent_storage:/tmp/agno
    networks:
      - coolify
    deploy:
      resources:
        limits:
          memory: 1G

  web:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - "3000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`medflow.trafegoparaconsultorios.com.br`)"
      - "traefik.http.routers.web.entrypoints=https"
      - "traefik.http.routers.web.tls=true"
      - "traefik.http.routers.web.tls.certresolver=letsencrypt"
      - "traefik.http.services.web.loadbalancer.server.port=3000"
    environment:
      API_URL: http://integration:8000
      NODE_ENV: production
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      integration:
        condition: service_healthy
    networks:
      - coolify
    deploy:
      resources:
        limits:
          memory: 512M

  creative-studio:
    build:
      context: ./creative-studio
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - "3001"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.creative-studio.rule=Host(`studio.trafegoparaconsultorios.com.br`)"
      - "traefik.http.routers.creative-studio.entrypoints=https"
      - "traefik.http.routers.creative-studio.tls=true"
      - "traefik.http.routers.creative-studio.tls.certresolver=letsencrypt"
      - "traefik.http.routers.creative-studio.middlewares=studio-auth"
      - "traefik.http.middlewares.studio-auth.forwardauth.address=http://integration:8000/api/auth/verify"
      - "traefik.http.middlewares.studio-auth.forwardauth.trustForwardHeader=true"
      - "traefik.http.services.creative-studio.loadbalancer.server.port=3001"
    environment:
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - coolify
    deploy:
      resources:
        limits:
          memory: 256M


  intel-api:
    build:
      context: ./intel-api
      dockerfile: Dockerfile
      args:
        CACHEBUST: "20260123-3"
    restart: unless-stopped
    expose:
      - "8001"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.intel-api.rule=Host(`intel.trafegoparaconsultorios.com.br`) && (PathPrefix(`/api`) || Path(`/health`))"
      - "traefik.http.routers.intel-api.entrypoints=https"
      - "traefik.http.routers.intel-api.tls=true"
      - "traefik.http.routers.intel-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.intel-api.middlewares=intel-auth"
      - "traefik.http.middlewares.intel-auth.forwardauth.address=http://integration:8000/api/auth/verify"
      - "traefik.http.middlewares.intel-auth.forwardauth.trustForwardHeader=true"
      - "traefik.http.services.intel-api.loadbalancer.server.port=8001"
    environment:
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}
      APIFY_TOKEN: ${APIFY_TOKEN:-}
      META_ACCESS_TOKEN: ${META_ACCESS_TOKEN:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      DEBUG: ${DEBUG:-false}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      integration:
        condition: service_healthy
    networks:
      - coolify
    deploy:
      resources:
        limits:
          memory: 512M

  intel-web:
    build:
      context: ./intel-web
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - "3002"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.intel-web.rule=Host(`intel.trafegoparaconsultorios.com.br`)"
      - "traefik.http.routers.intel-web.entrypoints=https"
      - "traefik.http.routers.intel-web.tls=true"
      - "traefik.http.routers.intel-web.tls.certresolver=letsencrypt"
      - "traefik.http.routers.intel-web.middlewares=intel-web-auth"
      - "traefik.http.middlewares.intel-web-auth.forwardauth.address=http://integration:8000/api/auth/verify"
      - "traefik.http.middlewares.intel-web-auth.forwardauth.trustForwardHeader=true"
      - "traefik.http.services.intel-web.loadbalancer.server.port=3002"
    environment:
      NEXT_PUBLIC_API_URL: https://intel.trafegoparaconsultorios.com.br/api
      INTEL_API_URL: http://intel-api:8001
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}
      NODE_ENV: production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      intel-api:
        condition: service_healthy
    networks:
      - coolify
    deploy:
      resources:
        limits:
          memory: 512M


networks:
  coolify:
    external: true
    name: coolify

volumes:
  agent_storage:
    driver: local
